<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Booth â€” View Photo</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“¸</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <style>
    :root { --bg: #0C0C18; --bg-card: #141426; --border: #28284A; --text: #EEEEF5; --text-dim: #8585A8; --accent: #FF6B9D; --primary-light: #B4A7FF; --danger: #F87171; --radius: 14px; }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }

    .viewer-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); max-width: 500px; width: 100%; overflow: hidden; box-shadow: 0 16px 64px rgba(0,0,0,0.4); }
    .viewer-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .viewer-header .material-icons-round { font-size: 24px; color: var(--accent); }
    .viewer-header h1 { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; background: linear-gradient(135deg, var(--primary-light), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .viewer-img { width: 100%; display: block; background: #000; }
    .viewer-info { padding: 16px 20px; display: flex; flex-direction: column; gap: 8px; }
    .viewer-meta { font-size: 0.85rem; color: var(--text-dim); }
    .viewer-meta strong { color: var(--text); }
    .viewer-meta small { color: var(--text-dim); opacity: 0.7; }

    .viewer-actions { display: flex; gap: 10px; margin-top: 8px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 12px 20px; border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s; flex: 1; justify-content: center; }
    .btn .material-icons-round { font-size: 18px; }
    .btn-primary { background: linear-gradient(135deg, #7C6AEF, var(--accent)); color: #fff; box-shadow: 0 2px 12px rgba(124,106,239,0.2); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(124,106,239,0.35); }

    .viewer-loading, .viewer-error { padding: 60px 20px; text-align: center; }
    .viewer-loading p, .viewer-error p { color: var(--text-dim); margin-top: 12px; font-size: 0.9rem; }
    .viewer-error .error-icon { font-size: 48px; color: var(--accent); }
    .viewer-error .error-deleted { color: var(--danger); font-weight: 600; font-size: 0.95rem; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .branding { margin-top: 24px; text-align: center; font-size: 0.75rem; color: var(--text-dim); opacity: 0.5; }
    .branding a { color: var(--primary-light); text-decoration: none; }
  </style>
</head>
<body>

  <div class="viewer-card">
    <div class="viewer-header">
      <span class="material-icons-round">photo_camera</span>
      <h1>Photo Booth</h1>
    </div>

    <div id="viewLoading" class="viewer-loading">
      <div class="spinner"></div>
      <p>Loading your photo...</p>
    </div>

    <div id="viewError" class="viewer-error" style="display:none;">
      <span class="material-icons-round error-icon" id="errorIcon">broken_image</span>
      <p id="errorMsg"></p>
    </div>

    <div id="viewContent" style="display:none;">
      <img id="viewImg" class="viewer-img" src="" alt="Photo Booth Photo">
      <div class="viewer-info">
        <div class="viewer-meta" id="viewMeta"></div>
        <div class="viewer-actions">
          <button class="btn btn-primary" onclick="downloadPhoto()"><span class="material-icons-round">download</span> Save Photo</button>
        </div>
      </div>
    </div>
  </div>

  <div class="branding">
    <a href="../">ðŸ“¸ Photo Booth</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDLBz2VU3bOb_aTx32VQcHDjYautJt7Bc0",
      authDomain: "swiftly-photobooth.firebaseapp.com",
      projectId: "swiftly-photobooth",
      storageBucket: "swiftly-photobooth.firebasestorage.app",
      messagingSenderId: "539796809069",
      appId: "1:539796809069:web:aa13d56e96a498b9d4f04c"
    };

    var photoData = null;

    function init() {
      var params = new URLSearchParams(window.location.search);
      var docId = params.get('id');

      if (!docId) {
        showError('no-id', 'No photo ID provided in the URL.');
        return;
      }

      try {
        firebase.initializeApp(firebaseConfig);

        // Sign in anonymously so Firestore rules allow read
        firebase.auth().signInAnonymously()
          .then(function() {
            console.log('[View] Signed in anonymously');
            return firebase.firestore().collection('gallery').doc(docId).get();
          })
          .then(function(doc) {
            if (!doc || !doc.exists) {
              showError('deleted', 'This photo has been removed from the gallery.');
              return;
            }
            photoData = doc.data();
            if (!photoData.imageData) {
              showError('deleted', 'This photo has been removed from the gallery.');
              return;
            }
            showPhoto(photoData);
          })
          .catch(function(err) {
            console.error('[View] Error:', err);
            if (err.code === 'permission-denied') {
              showError('error', 'Access denied. The photo may have been removed.');
            } else if (err.code === 'not-found') {
              showError('deleted', 'This photo has been removed from the gallery.');
            } else {
              showError('error', 'Could not load photo. Please try again.');
            }
          });
      } catch(e) {
        console.error('[View] Init error:', e);
        showError('error', 'Something went wrong loading the page.');
      }
    }

    function showPhoto(data) {
      document.getElementById('viewLoading').style.display = 'none';
      document.getElementById('viewContent').style.display = 'block';
      document.getElementById('viewImg').src = data.imageData;

      var date = '';
      if (data.createdAt) {
        try {
          var d = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt);
          date = d.toLocaleString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        } catch(e) {}
      }

      var meta = '<strong>' + (data.eventTitle || 'Photo Booth') + '</strong>';
      if (data.userName) meta += '<br>By ' + data.userName;
      if (date) meta += '<br><small>' + date + '</small>';
      document.getElementById('viewMeta').innerHTML = meta;
    }

    function showError(type, msg) {
      document.getElementById('viewLoading').style.display = 'none';
      var el = document.getElementById('viewError');
      el.style.display = 'block';

      var icon = document.getElementById('errorIcon');
      var msgEl = document.getElementById('errorMsg');

      if (type === 'deleted') {
        icon.textContent = 'delete_forever';
        icon.style.color = '#F87171';
        msgEl.innerHTML = '<span class="error-deleted">Your image has already been removed.</span><br><small style="color:#8585A8;">The photo was deleted from the gallery by the organizer.</small>';
      } else if (type === 'no-id') {
        icon.textContent = 'link_off';
        msgEl.textContent = msg;
      } else {
        icon.textContent = 'broken_image';
        msgEl.textContent = msg;
      }
    }

    function downloadPhoto() {
      if (!photoData || !photoData.imageData) return;
      var a = document.createElement('a');
      a.download = 'photobooth_' + Date.now() + '.png';
      a.href = photoData.imageData;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    init();
  </script>
</body>
</html>
