<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Booth</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“¸</text></svg>">
  <style>
    #splashScreen{position:fixed;inset:0;z-index:9999;background:#0C0C18;display:flex;align-items:center;justify-content:center;transition:opacity .35s ease}
    .splash-inner{text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px}
    .splash-emoji{font-size:56px;animation:sp 1.5s ease-in-out infinite}
    .splash-title{font-family:Georgia,serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#B4A7FF,#FF6B9D);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-spinner{width:28px;height:28px;border:3px solid #28284A;border-top-color:#FF6B9D;border-radius:50%;animation:spin .8s linear infinite;margin-top:8px}
    @keyframes sp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld0RWgsAAAAABRdIcHVQcVkgAswfd_wb4mluzfY"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
  <script>var PAGE_TYPE = 'private';</script>
</head>
<body>

  <div id="splashScreen"><div class="splash-inner"><div class="splash-emoji">ðŸ“¸</div><h1 class="splash-title">Photo Booth</h1><div class="splash-spinner"></div></div></div>

  <div id="pageContent" style="display:none;">
    <header class="app-header">
      <div class="header-left">
        <span class="material-icons-round logo-icon">photo_camera</span>
        <h1>Photo Booth</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <span class="user-name" id="userName"></span>
          <img class="user-avatar" id="userAvatar" src="" alt="">
        </div>
        <button class="icon-btn" id="btnKiosk" onclick="toggleKiosk()" title="Kiosk Mode"><span class="material-icons-round">fullscreen</span></button>
        <a class="icon-btn" href="gallery/" title="Gallery"><span class="material-icons-round">photo_library</span></a>
        <a class="icon-btn" href="profile/" title="Profile"><span class="material-icons-round">person</span></a>
        <button class="icon-btn" onclick="toggleSettings()" title="Settings"><span class="material-icons-round">tune</span></button>
        <button class="icon-btn" onclick="handleLogout()" title="Sign Out"><span class="material-icons-round">logout</span></button>
      </div>
    </header>

    <main class="main-content">
      <div class="booth-area">
        <div class="camera-panel">
          <div class="camera-container" id="cameraContainer">
            <video id="video" autoplay playsinline muted></video>
            <div class="countdown-overlay" id="countdownOverlay"><span id="countdownNumber"></span></div>
            <div class="flash-overlay" id="flashOverlay"></div>
            <div class="camera-off" id="cameraOff">
              <span class="material-icons-round">videocam_off</span><p>Camera is off</p>
              <button class="btn btn-primary" onclick="startCamera()"><span class="material-icons-round">videocam</span> Start Camera</button>
            </div>
            <div class="shot-counter" id="shotCounter"></div>
          </div>
          <div class="camera-controls">
            <button class="ctrl-btn" onclick="flipCamera()" title="Flip"><span class="material-icons-round">flip_camera_ios</span></button>
            <button class="capture-btn" id="btnCapture" onclick="startCapture()" title="Capture"><span class="material-icons-round">camera</span></button>
            <button class="ctrl-btn" onclick="cycleTimer()" title="Timer"><span class="material-icons-round">timer</span><span class="timer-badge" id="timerBadge">OFF</span></button>
          </div>
        </div>
        <div class="preview-panel" id="previewPanel">
          <div class="preview-label"><span class="material-icons-round">preview</span> Live Preview</div>
          <div class="preview-strip-wrap"><canvas id="livePreviewCanvas"></canvas></div>
          <div class="preview-actions" id="previewActions" style="display:none;">
            <button class="btn btn-sm btn-outline" onclick="resetBooth()"><span class="material-icons-round">replay</span> Reset</button>
            <button class="btn btn-sm btn-outline" onclick="downloadPhoto()"><span class="material-icons-round">download</span> Download</button>
            <button class="btn btn-sm btn-outline" onclick="printPhoto()"><span class="material-icons-round">print</span> Print</button>
            <button class="btn btn-sm btn-outline" onclick="showReviewScreen()"><span class="material-icons-round">edit</span> Retake</button>
            <button class="btn btn-sm btn-outline" id="btnViewQR" onclick="showQRModal()" style="display:none;"><span class="material-icons-round">qr_code_2</span> QR</button>
            <button class="btn btn-sm btn-primary" onclick="openEmailModal()"><span class="material-icons-round">email</span> Email</button>
          </div>
          <div class="status-msg" id="statusMsg"></div>
        </div>
      </div>
      <section class="option-section"><h3><span class="material-icons-round">grid_view</span> Layout</h3><div class="option-scroll" id="layoutGrid"></div></section>
      <section class="option-section"><h3><span class="material-icons-round">filter_frames</span> Frame</h3><div class="option-scroll" id="frameGrid"></div></section>
      <section class="option-section"><h3><span class="material-icons-round">auto_awesome</span> Filter</h3><div class="option-scroll" id="filterGrid"></div></section>
    </main>
  </div>

  <!-- Review Modal -->
  <div class="modal-backdrop" id="reviewModal">
    <div class="modal-content review-modal">
      <div class="modal-header">
        <h2>Review Photos</h2>
        <button class="icon-btn" onclick="document.getElementById('reviewModal').classList.remove('active')"><span class="material-icons-round">close</span></button>
      </div>
      <div class="modal-body">
        <p class="modal-desc">Tap <b>Retake</b> on any photo to re-shoot it, or approve all to finalize.</p>
        <div class="review-grid" id="reviewGrid"></div>
        <div class="form-actions" style="margin-top:16px;">
          <button class="btn btn-outline" onclick="resetBooth()"><span class="material-icons-round">replay</span> Start Over</button>
          <button class="btn btn-primary" onclick="approveAllPhotos()"><span class="material-icons-round">check</span> Approve All</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div class="modal-backdrop" id="emailModal">
    <div class="modal-content email-modal">
      <div class="modal-header"><h2>Send Photo</h2><button class="icon-btn" onclick="closeEmailModal()"><span class="material-icons-round">close</span></button></div>
      <div class="modal-body">
        <p class="modal-desc">Enter your email to receive this photo.</p>
        <div class="form-group"><label>Your Name</label><input type="text" id="recipientName" placeholder="Juan Dela Cruz" maxlength="60"></div>
        <div class="form-group"><label>Your Email</label><input type="email" id="recipientEmail" placeholder="juan@email.com"></div>
        <div class="form-actions">
          <button class="btn btn-outline" onclick="closeEmailModal()">Cancel</button>
          <button class="btn btn-primary" id="btnSendEmail" onclick="sendEmail()"><span class="material-icons-round">send</span> Send</button>
        </div>
        <div class="email-status" id="emailStatus"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="modal-content settings-modal">
      <div class="modal-header"><h2>Settings</h2><button class="icon-btn" onclick="toggleSettings()"><span class="material-icons-round">close</span></button></div>
      <div class="settings-body">
        <div class="setting-row"><label>Mirror Camera</label><label class="switch"><input type="checkbox" id="settingMirror" checked onchange="updateSettings()"><span class="slider"></span></label></div>
        <div class="setting-row"><label>Flash Effect</label><label class="switch"><input type="checkbox" id="settingFlash" checked onchange="updateSettings()"><span class="slider"></span></label></div>
        <div class="setting-row"><label>Shutter Sound</label><label class="switch"><input type="checkbox" id="settingSound" checked onchange="updateSettings()"><span class="slider"></span></label></div>
        <hr class="setting-divider">
        <h4 class="setting-section-title">Event</h4>
        <div class="setting-row"><label>Title</label><input type="text" id="settingTitle" placeholder="e.g. Wedding" maxlength="50" onchange="updateSettings()"></div>
        <div class="setting-row"><label>Date</label><input type="text" id="settingDate" placeholder="e.g. Feb 14, 2025" maxlength="30" onchange="updateSettings()"></div>
        <hr class="setting-divider">
        <h4 class="setting-section-title">Features</h4>
        <div class="setting-row"><label>QR Code on Prints</label><label class="switch"><input type="checkbox" id="settingShowQR" checked onchange="updateSettings()"><span class="slider"></span></label></div>
        <div class="setting-row"><label>Auto-save to Gallery</label><label class="switch"><input type="checkbox" id="settingSaveGallery" checked onchange="updateSettings()"><span class="slider"></span></label></div>
        <hr class="setting-divider">
        <h4 class="setting-section-title">EmailJS</h4>
        <p class="setting-hint"><a href="https://www.emailjs.com/" target="_blank">emailjs.com</a></p>
        <div class="setting-row"><label>Public Key</label><input type="text" id="settingEmailPublicKey" placeholder="Public key" onchange="updateSettings()"></div>
        <div class="setting-row"><label>Service ID</label><input type="text" id="settingEmailServiceId" placeholder="service_xxx" onchange="updateSettings()"></div>
        <div class="setting-row"><label>Template ID</label><input type="text" id="settingEmailTemplateId" placeholder="template_xxx" onchange="updateSettings()"></div>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div class="modal-backdrop" id="qrModal">
    <div class="modal-content" style="max-width:360px;text-align:center;">
      <div class="modal-header"><h2>Scan to Save Photo</h2><button class="icon-btn" onclick="closeQRModal()"><span class="material-icons-round">close</span></button></div>
      <div class="modal-body" style="padding:24px;">
        <canvas id="qrModalCanvas" style="width:240px;height:240px;image-rendering:pixelated;margin:0 auto;display:block;border-radius:8px;"></canvas>
        <p id="qrModalUrl" style="font-size:0.72rem;color:#8585A8;margin-top:12px;word-break:break-all;"></p>
        <p style="font-size:0.82rem;color:#EEEEF5;margin-top:8px;">Point your phone camera at this code to view and download your photo â€” no login needed!</p>
      </div>
    </div>
  </div>

  <iframe id="printFrame" style="position:absolute;left:-9999px;top:-9999px;width:0;height:0;border:none;"></iframe>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="auth.js"></script>
  <script src="script.js"></script>
  <script>
    function onAuthReady(user) {
      if (!user) return;
      document.getElementById('userName').textContent = user.displayName || user.email.split('@')[0];
      var av = document.getElementById('userAvatar');
      if (user.photoURL) { av.src = user.photoURL; av.style.display = 'block'; } else av.style.display = 'none';
      initPhotoBooth();
    }
  </script>
</body>
</html>
