<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gallery â€” Photo Booth</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“¸</text></svg>">
  <style>
    #splashScreen{position:fixed;inset:0;z-index:9999;background:#0C0C18;display:flex;align-items:center;justify-content:center;transition:opacity .35s ease}
    .splash-inner{text-align:center;display:flex;flex-direction:column;align-items:center;gap:12px}
    .splash-emoji{font-size:56px;animation:sp 1.5s ease-in-out infinite}
    .splash-title{font-family:Georgia,serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,#B4A7FF,#FF6B9D);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .splash-spinner{width:28px;height:28px;border:3px solid #28284A;border-top-color:#FF6B9D;border-radius:50%;animation:spin .8s linear infinite;margin-top:8px}
    @keyframes sp{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.05)}}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
  <script src="https://www.google.com/recaptcha/api.js?render=6Ld0RWgsAAAAABRdIcHVQcVkgAswfd_wb4mluzfY"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@4/dist/fp.min.js"></script>
  <script>var PAGE_TYPE = 'private';</script>
</head>
<body>

  <div id="splashScreen"><div class="splash-inner"><div class="splash-emoji">ðŸ“¸</div><h1 class="splash-title">Photo Booth</h1><div class="splash-spinner"></div></div></div>

  <div id="pageContent" style="display:none;">
    <header class="app-header">
      <div class="header-left">
        <a href="../" class="back-link"><span class="material-icons-round">arrow_back</span></a>
        <span class="material-icons-round logo-icon">photo_camera</span>
        <h1>Gallery</h1>
      </div>
      <div class="header-right">
        <button class="icon-btn" onclick="handleLogout()" title="Sign Out"><span class="material-icons-round">logout</span></button>
      </div>
    </header>

    <main class="main-content">
      <div class="gallery-header">
        <div class="gallery-stats">
          <span class="material-icons-round">photo_library</span>
          <span id="galleryCount">Loading...</span>
        </div>
      </div>

      <div id="galleryLoading" class="gallery-loading">
        <div class="splash-spinner" style="margin:40px auto;"></div>
        <p style="text-align:center;color:#8585A8;">Loading gallery...</p>
      </div>

      <div id="galleryEmpty" class="gallery-empty" style="display:none;">
        <span class="material-icons-round" style="font-size:64px;color:#28284A;">photo_library</span>
        <h3>No photos yet</h3>
        <p>Photos will appear here after they're captured and approved.</p>
        <a href="../" class="btn btn-primary"><span class="material-icons-round">camera</span> Take Photos</a>
      </div>

      <div id="galleryGrid" class="gallery-grid" style="display:none;"></div>
    </main>
  </div>

  <!-- Lightbox -->
  <div class="lightbox-overlay" id="lightboxOverlay" style="display:none;">
    <button class="lightbox-close" onclick="closeLightbox()"><span class="material-icons-round">close</span></button>
    <div class="lightbox-center">
      <img id="lightboxImg" src="" alt="Photo">
    </div>
    <div class="lightbox-bottom">
      <div style="display:flex;gap:10px;">
        <button class="btn btn-outline lightbox-btn" onclick="downloadLightboxPhoto()"><span class="material-icons-round">download</span> Download</button>
        <button class="btn btn-outline lightbox-btn lightbox-delete-btn" onclick="deleteLightboxPhoto()"><span class="material-icons-round">delete</span> Delete</button>
      </div>
      <div class="lightbox-meta" id="lightboxMeta"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="../auth.js"></script>

  <script>
    var galleryPhotos = [];
    var currentLightboxIdx = -1;

    function onAuthReady(user) {
      if (!user) return;
      loadGallery();
    }

    function loadGallery() {
      var firebasePhotos = [];
      var localPhotos = [];

      try {
        localPhotos = JSON.parse(localStorage.getItem('pb_gallery') || '[]');
        localPhotos.forEach(function(p) { p.storage = 'local'; });
      } catch(e) { localPhotos = []; }

      if (db) {
        db.collection('gallery').orderBy('createdAt', 'desc').limit(100).get()
          .then(function(snapshot) {
            snapshot.forEach(function(doc) {
              var d = doc.data();
              d.id = doc.id;
              d.storage = 'cloud';
              firebasePhotos.push(d);
            });
            galleryPhotos = firebasePhotos.concat(localPhotos);
            showGallery();
          })
          .catch(function(err) {
            console.warn('[Gallery] Firestore error:', err);
            galleryPhotos = localPhotos;
            showGallery();
          });
      } else {
        galleryPhotos = localPhotos;
        showGallery();
      }
    }

    function showGallery() {
      document.getElementById('galleryLoading').style.display = 'none';

      var cloudCount = galleryPhotos.filter(function(p) { return p.storage === 'cloud'; }).length;
      var localCount = galleryPhotos.filter(function(p) { return p.storage === 'local'; }).length;
      var total = galleryPhotos.length;

      var countText = total + ' photo' + (total !== 1 ? 's' : '');
      var parts = [];
      if (cloudCount > 0) parts.push(cloudCount + ' cloud');
      if (localCount > 0) parts.push(localCount + ' local');
      if (parts.length > 0) countText += ' (' + parts.join(', ') + ')';
      document.getElementById('galleryCount').textContent = countText;

      if (total === 0) {
        document.getElementById('galleryEmpty').style.display = 'flex';
        document.getElementById('galleryGrid').style.display = 'none';
        return;
      }

      document.getElementById('galleryEmpty').style.display = 'none';
      var grid = document.getElementById('galleryGrid');
      grid.style.display = 'grid';
      grid.innerHTML = '';

      galleryPhotos.forEach(function(photo, idx) {
        var date = '';
        if (photo.createdAt) {
          try {
            var d = photo.createdAt.toDate ? photo.createdAt.toDate() : new Date(photo.createdAt);
            date = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          } catch(e) {}
        }

        var isCloud = photo.storage === 'cloud';
        var badgeClass = isCloud ? 'storage-badge-cloud' : 'storage-badge-local';
        var badgeIcon = isCloud ? 'cloud' : 'smartphone';
        var badgeText = isCloud ? 'Cloud' : 'Local';

        var card = document.createElement('div');
        card.className = 'gallery-card';
        card.innerHTML =
          '<div class="gallery-card-img" onclick="openLightbox(' + idx + ')">' +
            '<img src="' + photo.imageData + '" alt="Photo" loading="lazy">' +
            '<span class="storage-badge ' + badgeClass + '"><span class="material-icons-round">' + badgeIcon + '</span> ' + badgeText + '</span>' +
          '</div>' +
          '<div class="gallery-card-info">' +
            '<div class="gallery-card-left">' +
              '<span class="gallery-card-user">' + (photo.userName || 'Guest') + '</span>' +
              '<span class="gallery-card-date">' + date + '</span>' +
            '</div>' +
            '<button class="gallery-delete-btn" onclick="deletePhoto(' + idx + ')" title="Delete">' +
              '<span class="material-icons-round">delete_outline</span>' +
            '</button>' +
          '</div>';
        grid.appendChild(card);
      });
    }

    // â”€â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function deletePhoto(idx) {
      var photo = galleryPhotos[idx];
      if (!photo) return;
      if (!confirm('Delete this photo? This cannot be undone.')) return;

      if (photo.storage === 'cloud' && photo.id && db) {
        db.collection('gallery').doc(photo.id).delete()
          .then(function() {
            console.log('[Gallery] Deleted from Firebase:', photo.id);
            galleryPhotos.splice(idx, 1);
            showGallery();
          })
          .catch(function(err) {
            console.error('[Gallery] Delete failed:', err);
            alert('Failed to delete from cloud. Try again.');
          });
      } else if (photo.storage === 'local') {
        try {
          var local = JSON.parse(localStorage.getItem('pb_gallery') || '[]');
          for (var i = 0; i < local.length; i++) {
            if (local[i].imageData === photo.imageData) { local.splice(i, 1); break; }
          }
          localStorage.setItem('pb_gallery', JSON.stringify(local));
        } catch(e) {}
        galleryPhotos.splice(idx, 1);
        showGallery();
      }
    }

    // â”€â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openLightbox(idx) {
      currentLightboxIdx = idx;
      var photo = galleryPhotos[idx];
      document.getElementById('lightboxImg').src = photo.imageData;

      var date = '';
      if (photo.createdAt) {
        try {
          var d = photo.createdAt.toDate ? photo.createdAt.toDate() : new Date(photo.createdAt);
          date = d.toLocaleString('en-US', { month:'long', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit' });
        } catch(e) {}
      }

      var isCloud = photo.storage === 'cloud';
      var storageHTML = isCloud
        ? '<span class="lightbox-storage lightbox-storage-cloud"><span class="material-icons-round">cloud</span> Cloud</span>'
        : '<span class="lightbox-storage lightbox-storage-local"><span class="material-icons-round">smartphone</span> Local</span>';

      document.getElementById('lightboxMeta').innerHTML =
        '<strong>' + (photo.userName || 'Guest') + '</strong>' +
        (photo.eventTitle ? ' &middot; ' + photo.eventTitle : '') +
        ' &middot; ' + storageHTML +
        (date ? '<br><small>' + date + '</small>' : '');

      document.getElementById('lightboxOverlay').style.display = 'flex';
    }

    function closeLightbox() {
      document.getElementById('lightboxOverlay').style.display = 'none';
      currentLightboxIdx = -1;
    }

    function downloadLightboxPhoto() {
      if (currentLightboxIdx < 0) return;
      var photo = galleryPhotos[currentLightboxIdx];
      var a = document.createElement('a');
      a.download = 'photobooth_' + Date.now() + '.png';
      a.href = photo.imageData;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function deleteLightboxPhoto() {
      if (currentLightboxIdx < 0) return;
      var idx = currentLightboxIdx;
      closeLightbox();
      deletePhoto(idx);
    }

    document.addEventListener('keydown', function(e) {
      if (document.getElementById('lightboxOverlay').style.display === 'flex' && e.key === 'Escape') closeLightbox();
    });
  </script>
</body>
</html>
